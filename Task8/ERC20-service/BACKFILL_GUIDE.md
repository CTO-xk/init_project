# 积分回溯计算指南

## 概述

当ERC20服务因程序错误或RPC问题导致长时间中断时，系统提供了完整的回溯计算机制来恢复缺失的积分。

## 故障场景分析

### 常见故障场景
1. **程序崩溃**：服务意外停止，积分计算中断
2. **RPC节点故障**：无法获取区块链数据，事件监听停止
3. **数据库连接问题**：无法记录余额变动和积分计算
4. **消息队列故障**：积分计算任务无法处理

### 影响范围
- 用户余额变动记录可能缺失
- 积分计算可能中断数天
- 用户积分奖励不准确

## 回溯解决方案

### 1. 自动恢复机制

系统启动时会自动检测长时间未计算的用户，并启动回溯：

```bash
# 正常启动服务，系统会自动检测并回溯
./erc20-service daemon --config config.yaml
```

**自动恢复条件**：
- 用户上次计算时间早于当前周期开始时间
- 用户超过正常计算间隔的2倍时间未计算
- 系统会根据时间跨度智能选择分割粒度
- 避免重复计算已处理的时间段

### 2. 手动回溯命令

#### 检查积分计算状态
```bash
# 检查指定链的积分计算状态
./erc20-service backfill check sepolia
```

#### 扫描并修复所有积分缺失
```bash
# 自动扫描并修复所有用户的积分缺失
./erc20-service backfill scan sepolia
```

#### 回溯指定时间段
```bash
# 回溯计算指定时间段的积分
./erc20-service backfill points sepolia 2024-01-01T00:00:00Z 2024-01-03T00:00:00Z
```

#### 健康检查
```bash
# 检查系统整体健康状态
./erc20-service health check
```

### 3. 回溯策略

#### 时间段分割
- 按小时分割长时间段，避免单次计算过载
- 检查每个时间段是否已计算，避免重复
- 支持断点续传，可多次执行

#### 数据完整性保证
- 基于`balance_changes`表的历史数据
- 使用时间加权平均余额计算积分
- 记录计算历史，支持审计

## 使用示例

### 场景1：服务中断3天后的恢复

```bash
# 1. 检查当前状态
./erc20-service health check

# 2. 检查积分计算状态
./erc20-service backfill check sepolia

# 3. 回溯计算缺失的积分（假设中断时间为2024-01-01到2024-01-04）
./erc20-service backfill points sepolia 2024-01-01T00:00:00Z 2024-01-04T00:00:00Z

# 4. 重新启动正常服务
./erc20-service daemon --config config.yaml
```

### 场景2：RPC节点故障恢复

```bash
# 1. 修复RPC连接后，检查事件监听是否正常
./erc20-service health check

# 2. 如果发现区块处理滞后，手动触发回溯
./erc20-service backfill points sepolia 2024-01-01T00:00:00Z 2024-01-02T00:00:00Z

# 3. 监控系统恢复情况
watch -n 60 './erc20-service health check'
```

## 监控和告警

### 健康检查指标
- **数据库连接状态**：确保数据存储正常
- **链处理状态**：检查最后处理区块和时间
- **积分计算状态**：统计滞后用户数量和平均滞后时间
- **总体评分**：0-100分，低于60分需要关注

### 建议的监控策略
1. **实时监控**：每5分钟检查一次健康状态
2. **告警阈值**：
   - 链处理滞后 > 2小时
   - 积分计算滞后 > 24小时
   - 总体评分 < 60分
3. **自动恢复**：检测到问题后自动触发回溯

## 最佳实践

### 1. 预防措施
- 使用高可用的RPC节点
- 配置数据库主从复制
- 设置消息队列持久化
- 定期备份数据库

### 2. 故障处理流程
1. **立即响应**：检测到故障后立即启动健康检查
2. **数据修复**：使用回溯命令恢复缺失数据
3. **服务恢复**：重启服务并监控运行状态
4. **数据验证**：对比修复前后的积分数据

### 3. 性能优化
- 大批量回溯时建议分批执行
- 监控数据库性能，必要时调整连接池
- 使用索引优化查询性能

## 故障排查

### 常见问题

#### Q: 回溯命令执行失败
```bash
# 检查数据库连接
./erc20-service health check

# 检查配置是否正确
./erc20-service backfill check sepolia
```

#### Q: 积分计算不准确
```bash
# 检查余额变动记录是否完整
# 查看points_calculation_history表
# 对比不同时间段的计算结果
```

#### Q: 系统性能下降
```bash
# 检查数据库性能
# 监控消息队列积压
# 调整回溯批次大小
```

### 日志分析
- 查看`daemon`日志了解服务状态
- 查看`backfill`日志了解回溯进度
- 查看`health`日志了解系统健康状态

## 总结

通过这套完整的回溯机制，系统能够：
1. **自动检测**长时间未计算的积分
2. **智能回溯**缺失的时间段
3. **避免重复**计算已处理的数据
4. **保证数据**的完整性和准确性
5. **提供工具**进行手动干预和监控

这确保了即使在严重故障的情况下，用户积分也能得到准确计算和补偿。
